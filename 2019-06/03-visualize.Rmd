---
title: "Visualize Democratic Candidate 2019 Data"
author: "Jane Doe"
output: github_document
---

```{r setup, include=FALSE}
# create image folder ----
if (!file.exists("figs/")) {
    dir.create("figs/")
}
# create data folder ----
if (!file.exists("data/")) {
    dir.create("data/")
}
knitr::opts_chunk$set(
    echo = TRUE, # show all code
    eval = TRUE,
    message = FALSE, 
    comment = "#> ",
    warning = TRUE,
    tidy = FALSE, # cleaner code printing
    size = "small",
    fig.path = "figs/") # smaller code
knitr::opts_knit$set(
    width = 78)
base::options(tibble.print_max = 25,
              tibble.width = 78)
```


# Motivation

This document visualizes the democratic candidate data from the first night of debates. 

## Packages 

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(Hmisc)
library(janitor)
library(magrittr)
library(rtweet)
library(visdat)
library(inspectdf)
library(DT)
```


## Import data 

```{r import, eval=TRUE, message=FALSE, warning=FALSE}
source("code/01-import.R")
```

## Wrangle data

See the script for more details.

```{r wrangle, eval=TRUE, message=FALSE, warning=FALSE}
source("code/02-wrangle.R")
```

# Visualize data

Start with visualizing as much of the data as possible. These two graphs answer the following two questions about the Twitter data: 1) "*what kind of variables are in the data set?*" and 2) "*how much are missing?*"


```{r visdat-inspectdf}
inspectdf::inspect_types(TwitterData) %>% 
  inspectdf::show_plot()
visdat::vis_miss(TwitterUsersData) + 
  ggplot2::coord_flip()
```

## Table summaries

We will use tables and graphs to explore the data we imported and wrangled and see if it looks like the `fivethirtyeight` data. We will start with a table of the data on voter preferences on candidates before and after the night of the election. 

```{r GSheetCand538Fav, eval=FALSE}
dplyr::filter(GSheetCand538Fav, candidate %in% c("Elizabeth Warren",
   "Tim Ryan", "Beto Oâ€™Rourke", "Amy Klobuchar", "Jay Inslee",
   "Tulsi Gabbard", "John Delaney", "Bill de Blasio", "Julian Castro",
   "Cory Booker")) %>% 
  DT::datatable(data = ., colnames = c("Democratic Candidate", 
    "Before the election", "After the first election",
    "After the second election"), 
    caption = 'source: https://53eig.ht/2Yg0Smp')
```

This looks identical to the data in the figure on the [article](https://projects.fivethirtyeight.com/democratic-debate-poll/). We will compare this to the data from the wikipedia table. 

```{r WikiPollCriterion}
knitr::kable(
WikiPollCriterion, align = 'c')
```

## Visualize Google trend data 

The next few visualizations are of the Google trend data. 

### Candidates with high polling criterions 

When we look at the candidates with the highest percent of polling criterion on the 26th, we see the following:

```{r top-3-candidates}
GtrendWikiIOTAirTime %>% 
    # limit to only the candidates with more than 10% of voters
  dplyr::filter(poll_perc_fct == "> 10.0% of voters") %>% 
    # put data on the x, 
  ggplot2::ggplot(aes(x = date, 
                      # hits on the y
             y = hits, 
             # color it by keyword
             color = keyword)) +
    # use a line
  ggplot2::geom_line(aes(group = keyword), show.legend = FALSE) + 
    # labels
  ggplot2::labs(
    x = "Date",
    y = "Google search hits",
  subtitle = "Google trends for candidates with > 10.0% polling") + 
    # add themes from ggthemes 
  ggthemes::theme_wsj(base_size = 7.5, 
                      title_family = "mono") +
    # use facets for both candidates on the same graph
  ggplot2::facet_wrap(~ keyword, ncol = 2)
```

This shows Warren doing well after the first night. If we narrow this down to the week of the debates and widen the list of candidates, we see the following:

### Candidates with low polling criterions

```{r 7-day-top-3}
GtrendWikiIOTAirTime7day <- GtrendWikiIOTAirTime %>% 
                                   dplyr::filter(date >= "2019-06-22" & 
                                                 date < "2019-06-30")
GtrendWikiIOTAirTime7day %>% 
  dplyr::filter(poll_perc_fct %in% c("> 10.0% of voters", 
                                     "2-4.0% of voters")) %>% 
  ggplot2::ggplot(aes(x = date, 
             y = hits, 
             color = keyword)) +
  ggplot2::geom_line(aes(group = keyword), show.legend = FALSE) + 
  ggplot2::labs(
    x = "Date",
    y = "Google search hits",
    title = "Google search hits",
    subtitle = "Democratic candidates with 1.0-4.0% of voters") + 
  ggthemes::theme_clean(base_size = 7.5) +
  ggplot2::facet_wrap(~ keyword, ncol = 2)
```

Now we can see Warren is definitely ahead of O'Rourke, but Booker has also moved above Warren. 

### Candidates with low polling criterions

For candidates in the lowest percentage of Polling Criterion, `1 - 1.3% of voters` we see the following: 

```{r google-middle-percent-candidates}
GtrendWikiIOTAirTime7day %>% 
  dplyr::filter(poll_perc_fct %in% c("> 10.0% of voters", 
                                     "2-4.0% of voters",
                                     "1 - 1.3% of voters")) %>% 
  ggplot2::ggplot(aes(x = date, 
             y = hits, 
             color = keyword)) +
  ggplot2::geom_line(aes(group = keyword), show.legend = FALSE) + 
  ggplot2::labs(
    x = "Date",
    y = "Google search hits",
    caption = paste0("Google search hits between ", 
                   min(GtrendWikiIOTAirTime7day$date),
                   " and ",
                   max(GtrendWikiIOTAirTime7day$date)),
    subtitle = "Google search hits for democratic candidates") + 
    ggthemes::theme_tufte(base_size = 7) +
    ggplot2::facet_wrap(~ keyword, ncol = 2)
```

This looks like Gabbard had a better night on Google than the other four candidates in this group.

### Women candidates

We can also check the `gender` categorical variable to see how the candidates break down across `Men` and `Women`

```{r Dems2020Debate01IOT-date-hits-women}
GtrendWikiIOTAirTime7day %>% 
  dplyr::filter(gender == "Women") %>% 
  ggplot2::ggplot(aes(x = date, 
             y = hits, 
             color = keyword)) +
  ggplot2::geom_line(aes(group = keyword), show.legend = FALSE) + 
  ggplot2::labs(subtitle = "Women Democratic Candidates",
    caption = paste0("Data between ", 
                   min(GtrendWikiIOTAirTime7day$date),
                   " and ",
                   max(GtrendWikiIOTAirTime7day$date))) + 
  ggthemes::theme_fivethirtyeight(base_size = 8) + 
  ggplot2::facet_wrap(. ~ keyword)
```

This shows Gubbard outperforming Warren in Google searches. And as for the men...

### Men candidates

We're going to use a different theme (`ggthemes::theme_tufte`) to look at the 

```{r GtrendWikiIOTAirTime7day-date-hits-men}
font <- "Helvetica"
GtrendWikiIOTAirTime7day %>% 
  dplyr::filter(gender == "Men") %>% 
  ggplot2::ggplot(aes(x = date, 
             y = hits, 
             color = keyword)) +
  ggplot2::geom_line(aes(group = keyword), 
            show.legend = FALSE) + 
  ggplot2::labs(
    x = "Date",
    y = "Google search hits",
    subtitle = "Google search trends for June 26, 2019 Democratic candidates",
    caption = "source: http://bit.ly/2SKZXt4") +
  ggthemes::theme_few() +
  ggplot2::facet_wrap(. ~ keyword, ncol = 3)
```

This shows Cory Booker doing the best, followed by John Delany. 

## Twitter data 

The twitter data for the first night of candidates are below. These data were collected ~1 week after the debates and the figure below shows the most common content for each metadata variable about the tweets. 

```{r TwitterDataPlotImb, message=FALSE, warning=FALSE}
TwitterDataPlotImb <- TwitterData %>% 
  inspectdf::inspect_imb() 
TwitterDataPlotImb %>% 
  inspectdf::show_plot(col_palette = 2)
```


```{r ts_plot}
TwitterData %>%
  ts_plot("3 hours") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = 
                   ggplot2::element_text(face = "bold")) 
```

The twitter search string included all the candidates, so this will need some additional cleaning/wrangling to figure out who is driving the trends. 

### Summarize Interest Data

What does the interest look like by location (i.e. `"region"`)? 

We've created a new data structure `Dems2020InterestByRegion`. What does it look like? We can use `skimr::skim_to_wide()` to answer this.

```{r Dems2020InterestByRegion}
# recheck the structure
GtrendDems2020InterestByRegion %>%
  skimr::skim_to_wide() %>% 
  dplyr::filter(type %in% c("integer", "numeric")) %>% 
  dplyr::select(variable, 
                n, 
                mean, 
                sd, 
                median = p50, 
                hist)
```

### Map the data by state

It looks like the variable of interest (`hits`) is pretty lopsided--what can we do about it? After googling, we discover [this article](https://medium.com/@TheDataGyan/day-8-data-transformation-skewness-normalization-and-much-more-4c144d370e55) with this information, 

> "The logarithm, x to log base 10 of x, or x to log base e of x (ln x), or x to log base 2 of x, is a strong transformation and can be used to reduce right skewness."

Now we've documented our thought process (the "why"), and can log-transform the data in the next graph. 

## Tulsi Gabbard 2020 searches

```{r visualize-Gabbard-locations}
GtrendDems2020InterestByRegion %>% 
  dplyr::filter(keyword %in% "Tulsi Gabbard 2020") %>% 
  ggplot(aes(x = long, 
             y = lat)) +
  ggplot2::geom_polygon(aes(group = group,
                   # get the log(hits)
                   fill = log(hits)), 
                   color = "white") + 
  ggthemes::theme_map() + 
  ggplot2::labs(
    title = "Google searches for Tulsi Gabbard in 2020 on June 26, 2019",
    subtitle = "lighter colors = more searches for 'Tulsi Gabbard 2020'",
    caption = "using RStudio and gtrendsR") 
```

## Cory Booker 2020 searches

These are the searches for Cory Booker on states. 

```{r visualize-Booker-locations}
GtrendDems2020InterestByRegion %>% 
  dplyr::filter(keyword == "Cory Booker 2020") %>% 
  ggplot(aes(x = long, 
             y = lat)) +
  ggplot2::geom_polygon(aes(group = group,
                   # get the log(hits)
                   fill = log(hits)), 
                   color = "white") + 
  ggthemes::theme_map() + 
  ggplot2::labs(
    title = "Google searches for Cory Booker in 2020 on June 26, 2019",
    subtitle = "lighter colors = more searches for 'Cory Booker 2020'",
    caption = "using RStudio and gtrendsR")
```


## Sharing your work

Click `knit` to get the markdown file to share.


## Ask more questions

What other questions can we answer with these data?





